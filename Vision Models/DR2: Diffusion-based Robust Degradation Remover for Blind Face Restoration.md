# DR2: Diffusion-based Robust Degradation Remover for Blind Face Restoration

## 1. 핵심 주장과 주요 기여

**DR2**는 사전 정의된 열화 모델에 의존하지 않고도 **미지의 복잡한 열화(degradation)에 대해 강건한(robust) 얼굴 복원**을 달성하는 새로운 방법론을 제시합니다.[1]

### 주요 기여

**첫째, 사전학습된 DDPM 활용을 통한 강건한 열화 제거**: DR2는 사전학습된 Denoising Diffusion Probabilistic Model(DDPM)을 활용하여 입력 이미지를 노이즈 상태로 확산시킨 후, 반복적 디노이징을 통해 열화를 제거합니다. 이 과정에서 다양한 열화 유형이 가우시안 노이즈로 변환되므로, 훈련 시 합성 열화 데이터를 사용하지 않고도 복잡한 열화에 강건하게 대응할 수 있습니다.[1]

**둘째, 2단계 프레임워크 설계**: DR2E 프레임워크는 DR2(열화 제거 모듈)와 Enhancement 모듈로 구성됩니다. DR2가 열화를 제거한 중간 결과(degradation-invariant)를 생성하면, Enhancement 모듈이 고품질 세부사항을 복원합니다. 이러한 설계로 다양한 복원 방법을 Enhancement 모듈로 유연하게 통합할 수 있습니다.[1]

**셋째, 최첨단 성능**: 심하게 열화된 합성 및 실제 데이터셋에서 기존 최첨단 방법들을 능가하는 성능을 입증했습니다.[1]

***

## 2. 해결하고자 하는 문제

### 문제 정의

기존 blind face restoration 방법들은 **사전 정의된 열화 모델로 합성된 훈련 데이터에 의존**합니다. 그러나 실제 환경에서 발생하는 열화는 훈련 시 가정한 열화와 다를 수 있으며, 이러한 불일치는 복원 성능을 저하시키고 아티팩트(artifacts)를 발생시킵니다.[1]

구체적으로 두 가지 경우에 아티팩트가 발생합니다:

1. **고주파 정보 부족**: 다운샘플링이나 블러로 인해 입력 이미지에 고주파 정보가 부족하면, 복원 네트워크가 충분한 정보를 생성하지 못합니다.
2. **손상된 고주파 정보**: 노이즈 등으로 인해 입력 이미지의 고주파 정보가 손상되면, 복원 네트워크가 이를 잘못 활용하여 복원합니다.[1]

실제 환경의 모든 열화 유형을 훈련 데이터에 포함시키는 것은 **비용이 높고 비현실적**이므로, 합성 열화 의존도를 낮추는 새로운 접근법이 필요합니다.[1]

***

## 3. 제안하는 방법론

### 3.1 핵심 가정 (Assumption)

DR2의 이론적 기반은 다음 가정에 있습니다:[1]

확산 과정 $$q(x_t|x_0)$$에 대해:
1. 중간 타임스텝 $$\tau$$가 존재하여 $$t > \tau$$일 때 $$q(x_t|x)$$와 $$q(y_t|y)$$의 거리가 특히 저주파 부분에서 가깝습니다.
2. $$\omega > \tau$$가 존재하여 $$q(x_\omega|x) \approx q(y_\omega|y)$$가 성립합니다.

이 가정은 고품질 이미지 $$x$$와 열화된 이미지 $$y$$가 유사한 저주파 콘텐츠를 공유하며, 충분히 큰 $$t$$에서 두 분포가 표준 가우시안 $$\mathcal{N}(0, I)$$에 가까워진다는 점에 근거합니다.[1]

### 3.2 수학적 정식화

**목표 함수**: 전체 프레임워크는 다음 우도를 최대화합니다:[1]

$$
p_{\psi,\phi}(x|y) = \int p_\psi(x|\hat{x}_0) p_\phi(\hat{x}_0|y) d\hat{x}_0 = \mathbb{E}_{\hat{x}_0 \sim p_\phi(\hat{x}_0|y)} [p_\psi(x|\hat{x}_0)]
$$

여기서 $$p_\phi(\hat{x}_0|y)$$는 열화 제거 모듈(DR2), $$p_\psi(x|\hat{x}_0)$$는 Enhancement 모듈에 해당합니다.

**열화 제거 모듈 재정식화**: 가정을 적용하면:[1]

$$
p_\phi(\hat{x}_0|y) = \int p(\hat{x}_0|x_\tau) p_\theta(x_\tau|y_\omega) q(y_\omega|y) dx_\tau dy_\omega \approx \int p(\hat{x}_0|x_\tau) p_\theta(x_\tau|x_\omega) q(x_\omega|x) dx_\tau dx_\omega
$$

여기서:

$$
p_\theta(x_\tau|x_\omega) = \prod_{t=\tau+1}^{\omega} p_\theta(x_{t-1}|x_t)
$$

### 3.3 DR2의 3단계 프로세스

#### (1) 초기 조건 설정 (Initial Condition at $$\omega$$)

열화된 이미지 $$y$$를 확산 과정을 통해 초기 조건 $$y_\omega$$로 변환합니다:[1]

$$
x_\omega := y_\omega = \sqrt{\bar{\alpha}_\omega} y + \sqrt{1 - \bar{\alpha}_\omega} \epsilon, \quad \epsilon \sim \mathcal{N}(0, I)
$$

여기서 $$\omega \in \{1, 2, \ldots, T\}$$이며, 디노이징 프로세스는 스텝 $$\omega$$에서 시작됩니다.

#### (2) 반복적 정제 (Iterative Refinement)

$$x_t$$에서 $$x_{t-1}$$로의 각 전이 후 ($$\tau + 1 \leq t \leq \omega$$), $$y_{t-1}$$을 샘플링하고 저주파 정보를 대체합니다:[1]

$$
x_{t-1} := \Phi_N(y_{t-1}) + (I - \Phi_N)(x_{t-1})
$$

여기서 $$\Phi_N(\cdot)$$은 다운샘플링과 업샘플링을 통해 구현된 저역 통과 필터(low-pass filter)입니다. 스케일 팩터 $$N$$은 저주파 대역폭을 제어합니다.

#### (3) 절단 출력 (Truncated Output at $$\tau$$)

타임스텝 $$\tau$$에서 예측된 노이즈를 사용하여 최종 출력 $$\hat{x}_0$$를 추정합니다:[1]

$$
\hat{x}_0 = \frac{1}{\sqrt{\bar{\alpha}_\tau}} \left( x_\tau - \sqrt{1 - \bar{\alpha}_\tau} \epsilon_\theta(x_\tau, \tau) \right)
$$

이 $$\hat{x}_0$$는 $$y$$의 기본 의미를 유지하면서 다양한 열화가 제거된 결과입니다.

### 3.4 모델 구조

**DDPM**: 사전학습된 DDPM은 고품질 얼굴 데이터셋(FFHQ 70,000장)에서 학습되었으며, 디노이징 U-Net $$\epsilon_\theta(x_t, t)$$로 파라미터화됩니다.[1]

**Enhancement 모듈**: DR2 출력 $$\hat{x}_0$$를 고품질 이미지로 매핑합니다. 논문에서는 SPARNetHD(얼굴 prior 없음)와 VQFR(Vector-Quantized codebook 사용)을 백본으로 사용했습니다. Enhancement 모듈은 독립적으로 훈련되며, 다음과 같이 구성된 데이터로 훈련됩니다:[1]

$$
y = \text{DR2}(x; N, \tau) \circledast k_o
$$

고품질 이미지 $$x$$를 DR2로 재구성한 후 가우시안 블러 커널 $$k_o$$를 적용합니다.

***

## 4. 성능 향상

### 4.1 정량적 결과

**CelebA-Test 합성 데이터셋**: 16×, 8×, 4× 업샘플링 태스크에서 평가했습니다. 심하게 열화된 16×와 8× 태스크에서 DR2+VQFR과 DR2+SPAR이 **LPIPS와 FID에서 최고 및 차상위 성능**을 달성했습니다.[1]

| Methods | 16× LPIPS↓ | 16× FID↓ | 8× LPIPS↓ | 8× FID↓ |
|---------|------------|----------|-----------|---------|
| GPEN | 0.4313 | 81.57 | 0.3745 | 64.00 |
| GFP-GAN | 0.5430 | 139.13 | 0.3233 | 56.88 |
| CodeFormer | 0.5176 | 117.17 | 0.3465 | 71.22 |
| **DR2+SPAR** | **0.3908** | 53.22 | 0.3218 | 56.29 |
| **DR2+VQFR** | 0.3893 | **47.29** | **0.3167** | **53.82** |

**실제 데이터셋**: WIDER-Critical(심한 열화), WIDER-Normal, CelebChild, LFW-Test에서 평가했습니다. WIDER-Critical에서 DR2+VQFR과 DR2+SPAR이 **FID 60.06과 61.66으로 최고 성능**을 보였습니다.[1]

### 4.2 정성적 결과

심하게 열화된 입력에서 기존 방법들(GPEN, GFP-GAN, CodeFormer)은 아티팩트를 생성하는 반면, **DR2는 깨끗하고 의미론적으로 일관된 중간 결과**를 생성하여 최종 복원 품질이 향상되었습니다.[1]

### 4.3 Diffusion 기반 방법과의 비교

- **SR3(Concatenation 방식)**: 입력의 작은 노이즈에도 민감하여 성능이 저하됩니다.[1]
- **ILVR**: 충실도(fidelity)와 품질(quality) 사이의 트레이드오프 문제가 있습니다. DR2는 DR2가 충실도를, Enhancement 모듈이 품질을 담당하여 이 문제를 완화합니다.[1]

***

## 5. 일반화 성능 향상

### 5.1 핵심 메커니즘

**열화 불변 중간 표현**: DR2의 가장 중요한 기여는 **다양한 열화 유형을 가우시안 노이즈로 통일**시키는 것입니다. Figure 2에서 보듯이, 확산 과정을 통해 가우시안 노이즈를 추가하면 다양한 열화(blur, noise, JPEG 압축 등)의 분포가 구별되지 않게 됩니다.[1]

**사전학습된 DDPM의 강건성**: 고품질 얼굴 이미지만으로 학습된 DDPM이 노이즈 상태에서도 의미론적 정보를 포착할 수 있으므로, 합성 열화 데이터 없이도 강건한 복원이 가능합니다.[1]

### 5.2 제어 파라미터의 역할

**$$N$$(다운샘플링 팩터)와 $$\tau$$(출력 스텝)**는 열화 제거와 충실도 사이의 균형을 조절합니다:[1]

- **큰 $$N$$과 $$\tau$$**: 열화를 효과적으로 제거하지만 충실도가 낮아집니다.
- **작은 $$N$$과 $$\tau$$**: 높은 충실도를 유지하지만 열화가 출력에 남을 수 있습니다.

Ablation study에서 CelebA-Test(8×, medium split)에 대해 다양한 $$(N, \tau)$$ 조합을 평가한 결과, $$N=4, 8, 16$$에서 PSNR과 identity distance(Deg)가 최적점에 동시에 도달했습니다.[1]

### 5.3 실제 데이터에 대한 일반화

**다양한 열화 수준**: mild, medium, severe 3개 스플릿에서 평가한 결과, severe 열화에서 DR2의 우수성이 두드러졌습니다. 기존 방법들은 훈련 시 보지 못한 심한 열화에서 실패하는 반면, **DR2는 합성 열화 데이터 없이도 강건한 성능**을 보였습니다.[1]

**실제 환경 적용**: WIDER-Critical과 같은 실제 저해상도 데이터에서 DDPM의 생성 능력 덕분에 시각적으로 더 자연스러운 결과를 생성했습니다.[1]

---

## 6. 한계점

### 6.1 샘플링 속도

DR2는 사전학습된 DDPM에 기반하므로 **샘플링 속도가 느립니다**. 총 0.25T 스텝만 수행하더라도 속도 문제가 있습니다. 해결 방안으로 diffusion acceleration 방법(예: 10 스텝마다 추론)과 DR2 출력 해상도를 낮게(256²) 유지하고 업샘플링을 Enhancement 모듈에 맡기는 방법을 제안합니다.[1]

### 6.2 제어 파라미터의 수동 선택

$$N$$과 $$\tau$$를 수동으로 선택해야 하는 것이 **주요 한계**입니다. 향후 연구로 NIQE와 같은 이미지 품질 평가 지표를 활용한 자동 탐색 알고리즘 개발을 제안합니다.[1]

### 6.3 경미한 열화에 대한 불필요성

입력 이미지의 열화가 경미하거나 없는 경우, DR2 변환이 입력의 디테일을 제거할 수 있습니다. 하지만 이는 blind face restoration의 일반적인 케이스가 아닙니다.[1]

***

## 7. 향후 연구에 미치는 영향 및 고려사항

### 7.1 영향

**Diffusion 모델의 새로운 활용**: DR2는 **생성이 아닌 열화 제거**에 diffusion 모델을 활용하는 새로운 패러다임을 제시했습니다. 이는 image restoration 분야에서 diffusion 모델의 적용 범위를 확장합니다.[1]

**2단계 프레임워크의 모듈성**: 열화 제거와 세부사항 복원을 분리함으로써 **기존 복원 방법을 쉽게 통합**할 수 있는 유연한 프레임워크를 제공합니다. 이는 향후 연구에서 다양한 Enhancement 백본을 실험할 수 있는 기반이 됩니다.[1]

**합성 데이터 의존도 감소**: 훈련 시 합성 열화 데이터가 필요 없다는 점은 **데이터 효율적인 학습 방향**을 제시하며, 실제 환경 적용 가능성을 높입니다.[1]

### 7.2 향후 연구 시 고려사항

**속도 최적화**: 실시간 응용을 위해 faster sampling 방법(DDIM, DPM-Solver 등)이나 경량화된 diffusion 모델을 탐구해야 합니다.[1]

**적응적 파라미터 선택**: NIQE, BRISQUE 등 no-reference 품질 메트릭을 활용한 자동 $$(N, \tau)$$ 선택 알고리즘 개발이 필요합니다.[1]

**다른 도메인으로의 확장**: 얼굴 복원 외에 일반 이미지 복원, 의료 영상, 위성 이미지 등 다양한 도메인으로 확장 가능성을 탐구할 수 있습니다.

**경량화된 Enhancement 모듈**: 모바일 환경에서의 배포를 고려하여 효율적인 Enhancement 백본 개발이 필요합니다.

**불확실성 정량화**: Diffusion 모델의 확률적 특성을 활용하여 복원 결과의 불확실성을 정량화하는 연구가 가능합니다.

[1](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/65988149/f1b56278-4924-4de6-9a46-a86b96e0eb86/2303.06885v3.pdf)
